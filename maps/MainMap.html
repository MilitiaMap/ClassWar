<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Fullscreen Map Centered on US</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Optional: Leaflet Fullscreen plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen@1.0.2/dist/leaflet.fullscreen.css" />
    
    <style>
        /* Make the map take the full screen */
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Layer control styling */
        .layer-control {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .layer-item {
            margin: 5px 0;
            cursor: pointer;
        }
        
        .layer-item input {
            margin-right: 5px;
        }
        
        /* Custom icon styling */
        .custom-div-icon {
            background: none;
            border: none;
        }
        
        .custom-div-icon i {
            /* Base styles only - size will be set dynamically by JS */
            text-shadow: 0px 0px 3px white, 0px 0px 5px white; /* Add outline for better visibility */
        }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Font Awesome JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <!-- Optional: Leaflet Fullscreen plugin JS -->
    <script src="https://unpkg.com/leaflet-fullscreen@1.0.2/dist/leaflet.fullscreen.js"></script>
    <script>
        // Initialize map
        var map = L.map('map', {
            fullscreenControl: true, // Enable fullscreen control
        }).setView([37.0902, -95.7129], 5); // Centered on US (latitude, longitude)
        
        // Add tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Create layer groups to allow toggling
        var federalPrisonsLayer = L.layerGroup().addTo(map);
        var militaryBasesLayer = L.layerGroup().addTo(map);
        var statePrisonsLayer = L.layerGroup().addTo(map);
        var doxLayer = L.layerGroup().addTo(map);
        
        // Define styles for different GeoJSON layers
        var federalPrisonsStyle = {
            color: "#FF0000",
            weight: 1,
            opacity: 0.7,
            fillOpacity: 0.5
        };
        
        var militaryBasesStyle = {
            color: "#0000FF",
            weight: 1,
            opacity: 0.7,
            fillOpacity: 0.5
        };
        
        var statePrisonsStyle = {
            color: "#FF6600",
            weight: 1,
            opacity: 0.7,
            fillOpacity: 0.5
        };
        
        var doxStyle = {
            color: "#008000",
            weight: 1,
            opacity: 0.7,
            fillOpacity: 0.5
        };
        
        // Function to calculate icon size based on zoom level
        function getIconSize(zoom) {
            // Start with a base size of 14px at zoom level 3
            // Increase by approximately 2-3px per zoom level
            var baseSize = 14;
            var factor = Math.max(0.6, zoom / 5);  // Scale factor
            return Math.round(baseSize * factor);
        }
        
        // Set initial icon size based on current zoom
        var initialIconSize = getIconSize(map.getZoom());
        
        // Custom icon creation function using Font Awesome
        function createCustomIcon(icon, markerColor, zoom) {
            var size = getIconSize(zoom);
            return L.divIcon({
                html: '<i class="fa ' + icon + '" style="color: ' + markerColor + '; font-size: ' + size + 'px;"></i>',
                iconSize: [size * 1.5, size * 1.5], // Container slightly larger than icon
                iconAnchor: [size * 0.75, size * 0.75], // Center of the icon
                className: 'custom-div-icon',
                iconSizeZoom: zoom // Store current zoom for reference
            });
        }
        
        // Function to create popup content
        function createPopupContent(feature, layer) {
            if (feature.properties) {
                var popupContent = "<div>";
                for (var key in feature.properties) {
                    popupContent += "<strong>" + key + ":</strong> " + feature.properties[key] + "<br>";
                }
                popupContent += "</div>";
                layer.bindPopup(popupContent);
            }
        }
        
        // Store references to markers for updating
        var allMarkers = [];
        
        // Load Federal Prisons GeoJSON
        fetch('FederalPrisons.geojson')
            .then(response => response.json())
            .then(data => {
                var federalPrisons = L.geoJSON(data, {
                    style: federalPrisonsStyle,
                    onEachFeature: function(feature, layer) {
                        createPopupContent(feature, layer);
                        // If it's a marker, store it for later updates
                        if (layer instanceof L.Marker) {
                            allMarkers.push({
                                marker: layer,
                                icon: 'fa-building',
                                color: '#FF0000'
                            });
                        }
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: createCustomIcon('fa-building', '#FF0000', map.getZoom())
                        });
                    }
                }).addTo(federalPrisonsLayer);
            })
            .catch(error => console.error('Error loading Federal Prisons GeoJSON:', error));
        
        // Load Military Bases GeoJSON
        fetch('MilitaryBases.geojson')
            .then(response => response.json())
            .then(data => {
                var militaryBases = L.geoJSON(data, {
                    style: militaryBasesStyle,
                    onEachFeature: function(feature, layer) {
                        createPopupContent(feature, layer);
                        // If it's a marker, store it for later updates
                        if (layer instanceof L.Marker) {
                            allMarkers.push({
                                marker: layer,
                                icon: 'fa-shield-alt',
                                color: '#0000FF'
                            });
                        }
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: createCustomIcon('fa-shield-alt', '#0000FF', map.getZoom())
                        });
                    }
                }).addTo(militaryBasesLayer);
            })
            .catch(error => console.error('Error loading Military Bases GeoJSON:', error));
        
        // Load State Prisons GeoJSON
        fetch('StatePrisons.geojson')
            .then(response => response.json())
            .then(data => {
                var statePrisons = L.geoJSON(data, {
                    style: statePrisonsStyle,
                    onEachFeature: function(feature, layer) {
                        createPopupContent(feature, layer);
                        // If it's a marker, store it for later updates
                        if (layer instanceof L.Marker) {
                            allMarkers.push({
                                marker: layer,
                                icon: 'fa-building',
                                color: '#FF6600'
                            });
                        }
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: createCustomIcon('fa-building', '#FF6600', map.getZoom())
                        });
                    }
                }).addTo(statePrisonsLayer);
            })
            .catch(error => console.error('Error loading State Prisons GeoJSON:', error));
        
        // Load dox GeoJSON
        fetch('dox.geojson')
            .then(response => response.json())
            .then(data => {
                var dox = L.geoJSON(data, {
                    style: doxStyle,
                    onEachFeature: function(feature, layer) {
                        createPopupContent(feature, layer);
                        // If it's a marker, store it for later updates
                        if (layer instanceof L.Marker) {
                            allMarkers.push({
                                marker: layer,
                                icon: 'fa-info-circle',
                                color: '#008000'
                            });
                        }
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: createCustomIcon('fa-info-circle', '#008000', map.getZoom())
                        });
                    }
                }).addTo(doxLayer);
            })
            .catch(error => console.error('Error loading dox GeoJSON:', error));
        
        // Update all markers when zoom changes
        map.on('zoomend', function() {
            var newZoom = map.getZoom();
            
            // Update all markers with new sized icons
            allMarkers.forEach(function(item) {
                var newIcon = createCustomIcon(item.icon, item.color, newZoom);
                item.marker.setIcon(newIcon);
            });
        });
        
        // Create layer control
        var layerControl = L.control({position: 'topright'});
        layerControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'layer-control');
            div.innerHTML = '<h4>Toggle Layers</h4>';
            
            div.innerHTML += '<div class="layer-item"><input type="checkbox" id="federal-prisons" checked><label for="federal-prisons"><i class="fa fa-building" style="color: #FF0000;"></i> Federal Prisons</label></div>';
            div.innerHTML += '<div class="layer-item"><input type="checkbox" id="military-bases" checked><label for="military-bases"><i class="fa fa-shield-alt" style="color: #0000FF;"></i> Military Bases</label></div>';
            div.innerHTML += '<div class="layer-item"><input type="checkbox" id="state-prisons" checked><label for="state-prisons"><i class="fa fa-building" style="color: #FF6600;"></i> State Prisons</label></div>';
            div.innerHTML += '<div class="layer-item"><input type="checkbox" id="dox" checked><label for="dox"><i class="fa fa-info-circle" style="color: #008000;"></i> Other Data</label></div>';
            
            // Prevent clicks on control from propagating to map
            L.DomEvent.disableClickPropagation(div);
            
            return div;
        };
        layerControl.addTo(map);
        
        // Set up event listeners for layer toggle
        map.on('layeradd', function() {
            // Wait for DOM to be ready for manipulation
            setTimeout(function() {
                // Helper function to add event listeners
                function addToggleListener(id, layer) {
                    var element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', function() {
                            if (this.checked) {
                                map.addLayer(layer);
                            } else {
                                map.removeLayer(layer);
                            }
                        });
                    }
                }
                
                // Add listeners to each checkbox
                addToggleListener('federal-prisons', federalPrisonsLayer);
                addToggleListener('military-bases', militaryBasesLayer);
                addToggleListener('state-prisons', statePrisonsLayer);
                addToggleListener('dox', doxLayer);
            }, 100);
        });
        
        // Add a scale control to the map
        L.control.scale().addTo(map);
    </script>
</body>
</html>
